name: Newsletter Draft & Publish

on:
  workflow_dispatch:
    inputs:
      stage:
        description: "Which stage to run"
        required: true
        default: draft
        type: choice
        options:
          - draft
          - publish
      month:
        description: "Target month in YYYY-MM format (defaults to current UTC month)"
        required: false
        type: string
  schedule:
    - cron: '0 8 1 * *'
  pull_request:
    types: [closed]
    branches: [main]
    paths:
      - 'src/data/newsletter/drafts/**'

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: newsletter-${{ github.ref }}
  cancel-in-progress: false

jobs:
  draft:
    name: Stage A - Draft generation
    if: >
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.stage == 'draft')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Resolve target month
        id: month
        shell: bash
        run: |
          INPUT_MONTH="${{ github.event.inputs.month }}"
          if [ -z "$INPUT_MONTH" ]; then
            TARGET_MONTH="$(date -u +'%Y-%m')"
          else
            TARGET_MONTH="$INPUT_MONTH"
          fi
          echo "target=$TARGET_MONTH" >> "$GITHUB_OUTPUT"
          echo "TARGET_MONTH=$TARGET_MONTH" >> "$GITHUB_ENV"

      - name: Build monthly snapshot if missing
        shell: bash
        run: |
          SNAPSHOT_PATH="src/data/monthly/${TARGET_MONTH}.json"
          if [ -f "$SNAPSHOT_PATH" ]; then
            echo "Snapshot already exists: $SNAPSHOT_PATH"
          else
            node scripts/generate-monthly-snapshot.js --month="$TARGET_MONTH" --ci
          fi

      - name: Run AI enrichment draft generation
        run: node scripts/generate-newsletter-draft.js --month="$TARGET_MONTH"

      - name: Open draft PR (draft files only)
        uses: peter-evans/create-pull-request@v7
        with:
          branch: automation/newsletter-draft-${{ steps.month.outputs.target }}
          commit-message: "chore(newsletter): draft ${{ steps.month.outputs.target }} newsletter"
          title: "chore(newsletter): draft ${{ steps.month.outputs.target }} newsletter"
          body: |
            ## Automated newsletter draft

            This PR was generated by the newsletter automation workflow (Stage A).

            - Month: `${{ steps.month.outputs.target }}`
            - Includes AI-enriched newsletter draft JSON + markdown files only
            - No publish/deploy content in this PR
          labels: |
            newsletter
            automated-pr
          add-paths: |
            src/data/newsletter/drafts/${{ steps.month.outputs.target }}.json
            src/data/newsletter/drafts/${{ steps.month.outputs.target }}.md

  publish:
    name: Stage B - Publish content
    if: >
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.stage == 'publish')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Resolve approved month
        id: month
        shell: bash
        run: |
          INPUT_MONTH="${{ github.event.inputs.month }}"
          if [ -n "$INPUT_MONTH" ]; then
            TARGET_MONTH="$INPUT_MONTH"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            TARGET_MONTH="$(date -u +'%Y-%m')"
          else
            echo "Publish stage requires month input in workflow_dispatch mode"
            exit 1
          fi
          echo "target=$TARGET_MONTH" >> "$GITHUB_OUTPUT"

      - name: Generate static newsletter page content from approved draft
        run: node scripts/publish-newsletter-page.js --month="${{ steps.month.outputs.target }}"

      - name: Commit published content
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(newsletter): publish ${{ steps.month.outputs.target }} newsletter content"
          file_pattern: src/data/newsletter/published/**
